<html>
<head>
    <title>Badminton Scheduler</title>
    <script type="text/javascript">
        class Player {
            constructor(name) {
                this.name = name;
                this.numGamesPlayed = 0;
                this.numConsecutiveGamesPlayed = 0;
            }

            findCourt(round, numCourts) {
                for (let courtIndex=0; courtIndex<numCourts; courtIndex++) {
                    const playerIndex = courtIndex*2;
                    if (round[playerIndex].name === this.name || round[playerIndex+1].name === this.name) {
                        return courtIndex;
                    }
                }
                return undefined;
            }

            priority(maxGamesPlayed) {
                const reachedLimit = this.numConsecutiveGamesPlayed >= 3;

                let result = this.numGamesPlayed === maxGamesPlayed ? 0 : 1000;
                result -= (reachedLimit ? this.numConsecutiveGamesPlayed : 0);
                return result;
            }
        }

        function inputVal(id) {
            return +document.getElementById(id).value;
        }

        function shuffle(array) {
            let i = array.length;
            while (i--) {
                const ri = Math.floor(Math.random() * i);
                [array[i], array[ri]] = [array[ri], array[i]];
            }
            return array;
        }

        function pickRandomSubset(array, count) {
            return shuffle(array).slice(0, count);
        }

        function uniqSortedRev(values) {
            return [...new Set(values)].sort((a, b) => b - a);
        }

        function selectOptimalPlayers(players, count) {
            const maxGamesPlayed = Math.max(...players.map(player => player.numGamesPlayed));

            const priorities = uniqSortedRev(players.map(p => p.priority(maxGamesPlayed)));
            const playersByPriority = priorities.map(p => players.filter(player => player.priority(maxGamesPlayed) === p));
            console.log({priorities, playersByPriority});

            const result = [];
            for (let players of playersByPriority) {
                const numRequired = count - result.length;
                if (players.length  <= numRequired) {
                    result.push(...players);
                } else {
                    result.push(...pickRandomSubset(players, numRequired));
                    break;
                }
            }

            return shuffle(result);
        }

        function generateNextRound(players, numCourts) {
            const currentRoundPlayers = selectOptimalPlayers(players, numCourts*2);

            for (let i=0; i<numCourts*2; i++) {
                currentRoundPlayers[i].numGamesPlayed++;
                currentRoundPlayers[i].numConsecutiveGamesPlayed++;
            }
            for (let i=0; i<players.length; i++) {
                const isPlaying = currentRoundPlayers.find(player => player.name === players[i].name);
                if (!isPlaying) {
                    players[i].numConsecutiveGamesPlayed = 0;
                }
            }

            return currentRoundPlayers;
        }

        function addCell(row, text) {
            const cellElem = document.createElement('td');
            cellElem.innerText = text;
            row.appendChild(cellElem);
        }

        function addHeader(row, html, colSpan=1, rowSpan=1) {
            const cellElem = document.createElement('th');
            cellElem.innerHTML = html;
            cellElem.colSpan = colSpan;
            cellElem.rowSpan = rowSpan;
            row.appendChild(cellElem);
        }

        function displayRounds(homeRounds, awayRounds, numCourts, numRounds) {
            const headRow = document.getElementById("roundsHead");
            headRow.innerHTML = '<th>Draw</th>';

            for (let i=0; i<numCourts; i++) {
                addHeader(headRow, `Court ${i+1}`, 3, 1);
            }

            const body = document.getElementById("roundsBody");
            body.innerHTML = '';

            for (let roundIndex=0; roundIndex<numRounds; roundIndex++) {
                const upperRow = document.createElement('tr');
                const lowerRow = document.createElement('tr');

                addHeader(upperRow, `Round ${roundIndex+1}`, 1, 2);
                for (let courtIndex=0; courtIndex<numCourts; courtIndex++) {
                    const playerIndex = courtIndex * 2;
                    addCell(upperRow, homeRounds[roundIndex][playerIndex].name);
                    addCell(upperRow, homeRounds[roundIndex][playerIndex+1].name);
                    addCell(upperRow, '');

                    addCell(lowerRow, awayRounds[roundIndex][playerIndex].name);
                    addCell(lowerRow, awayRounds[roundIndex][playerIndex+1].name);
                    addCell(lowerRow, '');
                }

                body.appendChild(upperRow);
                body.appendChild(lowerRow);
            }
        }

        function displayTeam(teamName, rounds, numCourts, numRounds, players) {
            const headRow = document.getElementById(teamName + "PlayersHead");
            headRow.innerHTML = '';

            addHeader(headRow, teamName);
            for (let i=0; i<players.length; i++) {
                addHeader(headRow, players[i].name);
            }

            const body = document.getElementById(teamName + "PlayersBody");
            console.log({body, name: teamName + "PlayersBody"});
            body.innerHTML = '';

            for (let roundIndex=0; roundIndex<numRounds; roundIndex++) {
                const row = document.createElement('tr');
                addHeader(row, `Round ${roundIndex+1}`);

                for (let i=0; i<players.length; i++) {
                    const courtIndex = players[i].findCourt(rounds[roundIndex], numCourts);
                    addCell(row, courtIndex === undefined ? '' : `C${courtIndex+1}`);
                }

                body.appendChild(row);
            }

            const row = document.createElement('tr');
            addHeader(row, `Games Played`);
            for (let i=0; i<players.length; i++) {
                addHeader(row, players[i].numGamesPlayed);
            }
            body.appendChild(row);
        }

        function regenerateTeam(teamName, numPlayers, numCourts, numRounds) {
            const players = [];
            for (let i = 0; i < numPlayers; i++) {
                players.push(new Player(teamName[0] + (i+1)));
            }

            let result = []
            for (let r=0; r<numRounds; r++) {
                console.log({r, teamName})
                const round = generateNextRound(players, numCourts);
                result.push(round);
            }

            displayTeam(teamName, result, numCourts, numRounds, players);

            return result;
        }

        function regenerate() {
            const numHomePlayers = inputVal("numberOfHomePlayers");
            const numAwayPlayers = inputVal("numberOfAwayPlayers");
            const numCourts = inputVal("numberOfCourts");
            const numRounds = inputVal("numberOfRounds");

            console.log({numHomePlayers, numAwayPlayers, numCourts, numRounds});

            const homeRounds = regenerateTeam("Home", numHomePlayers, numCourts, numRounds);
            const awayRounds = regenerateTeam("Away", numAwayPlayers, numCourts, numRounds);
            displayRounds(homeRounds, awayRounds, numCourts, numRounds);
        }
    </script>

    <style>
        table, td, th {
            border: 1px solid black;
        }

        td {
            min-width: 50px;
        }
    </style>
</head>
<body onload="regenerate()">
    <form>
        Number of Courts
        <input type="number" value="4" id="numberOfCourts" onchange="regenerate()"/>
        </br>
        </br>

        Number of Home Players
        <input type="number" value="11" id="numberOfHomePlayers" onchange="regenerate()"/>
        </br>

        Number of Away Players
        <input type="number" value="11" id="numberOfAwayPlayers" onchange="regenerate()"/>
        </br>
        </br>

        Number of Rounds to Generate
        <input type="number" value="16" id="numberOfRounds" onchange="regenerate()"/>

    </form>

    <table id="rounds">
        <thead>
        <tr id="roundsHead">

        </tr>
        </thead>
        <tbody id="roundsBody">

        </tbody>
    </table>
    <br/>

    <table id="HomePlayers">
        <thead>
        <tr id="HomePlayersHead">
        </tr>
        </thead>
        <tbody id="HomePlayersBody">
        </tbody>
    </table>
    <br/>

    <table id="AwayPlayers">
        <thead>
        <tr id="AwayPlayersHead">
        </tr>
        </thead>
        <tbody id="AwayPlayersBody">
        </tbody>
    </table>
</body>
</html>
